<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Plot</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
      body {
          padding-top: 70px;
      }
      .legend-color{
          padding: 0;
          margin: 0;
          border: 0;
          background: transparent;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/color.js"></script>
    <script>
      var tokens = location.pathname.split('/');
      var id = tokens[tokens.length - 1];
      var plot = new Plot(id);
      var logs = new Logs();


      function fetch_logs() {
          $.each(plot.series, function(id, s) {
              $.getJSON('/api/logs/' + s.log.id, function(l) {
                  var new_log = ! logs[s.log.id];
                  logs[s.log.id] = l;
                  if (new_log) {
                      refresh_plot();
                  }
              });
          });
      }

      function update_series() {
          for (var yaxis = 0; yaxis < 2; yaxis++) {
              var tbody = $('#series-' + yaxis + ' > tbody');
              tbody.empty();
              $.each(plot.series, function(_, series) {
                  if (series.yaxis != yaxis) return;

                  var tr = $('<tr></tr>').appendTo(tbody);
                  $('<td></td>').appendTo(tr).append(
                      $('<input></input>')
                          .attr('type', 'color')
                          .attr('class', 'legend-color')
                          .attr('value', int2hex(series.color))
                          .on('change', function() {
                              plot.series_modify(
                                  series, 'color', hex2int($(this).val()), function() {
                                      update_series();
                                  });
                          }));
                  $('<td></td>').appendTo(tr)
                                .attr('width', '70%')
                                .text(series.log.comment + ': ' + series.key);
                  $('<td></td>').appendTo(tr).append(
                      $('<button></button>')
                          .text('Delete')
                          .attr('type', 'button')
                          .attr('class', 'btn btn-danger btn-sm pull-right')
                          .on('click', function() {
                              plot.series_remove(series, function() {
                                  update_series();
                              });
                          }));
              });
          }

          update_dialog('series');
      }

      var chart = null;

      function refresh_plot() {
          var xunit = $('input[name=xunit]:checked').val();

          var yscales = ['linear', 'linear'];
          for (var yaxis = 0; yaxis < yscales.length; yaxis++) {
              if ($('#use-logscale-' + yaxis).is(':checked')) {
                  yscales[yaxis] = 'logarithmic';
              }
              if (chart && chart.options.scales.yAxes[yaxis].type != yscales[yaxis]) {
                  chart.destroy();
                  chart = null;
              }
          }

          var xmin = 0;
          var xmax = 0;

          var datasets = $.map(plot.series, function(s) {
              var log = logs[s.log.id];
              if (! log) {
                  return;
              }

              var data_with_key = $.map(log.content, function(l) {
                  if (s.key in l) {
                      return {x: l[xunit], y: l[s.key]};
                  }
              });

              xmax = Math.max(xmax, data_with_key[data_with_key.length - 1].x);

              var interval = 1;
              var point_limit = $('input[name=point-limit]:checked').val();
              if (point_limit != '' && data_with_key.length > point_limit) {
                  interval = data_with_key.length / point_limit;
              }

              var data = [];
              for (var i = 0; i < data_with_key.length; i += interval) {
                  data.push(data_with_key[Math.floor(i)]);
              }

              return {
                  label: s.log.comment,
                  data: data,
                  borderColor: int2rgb(s.color),
                  yAxisID: 'y' + s.yaxis,
                  pointDot: false,
                  fill: false
              };
          });

          if (! chart){
              chart = new Chart($('#plot'), {
                  type: 'line',
                  data: {datasets: datasets},
                  options: {
                      elements: {
                          line: {tension: 0},
                      },
                      scales: {
                          xAxes: [{type: 'linear', position: 'bottom'}],
                          yAxes: [
                              {id: 'y0', type: yscales[0], position: 'left'},
                              {id: 'y1', type: yscales[1], position: 'right',
                               gridLines: {drawOnChartArea: false}}]
                      },
                      legend: {display: false},
                      animation: false
                  }
              });
          }

          chart.data.datasets = datasets;
          chart.options.scales.xAxes[0].ticks.min = xmin;
          chart.options.scales.xAxes[0].ticks.max = xmax;
          chart.update();
      }

      function update_dialog(mode, yaxis) {
          var dialog_log = $('#dialog-log');
          var dialog_key = $('#dialog-key');
          var dialog_color = $('#dialog-color');
          var dialog_yaxis = $('input[name=dialog-yaxis]')
          var dialog_button= $('#dialog-button');

          if (mode == 'open') {
              dialog_log.prop('disabled', true);

              logs.fetch(function() {
                  dialog_log.empty();
                  $('<option></option>').appendTo(dialog_log)
                  logs.each(function(log) {
                      $('<option></option>')
                          .appendTo(dialog_log)
                          .attr('value', log.id)
                          .text(log.comment);
                  });
                  dialog_log.prop('disabled', false);
              });
          }

          if (mode == 'open' || mode == 'log') {
              dialog_key.prop('disabled', true);

              var id = dialog_log.val();
              if (id) {
                  var log = new Log(id);
                  log.fetch(function() {
                      var keys = {};
                      $.each(log.content, function(_, l){
                          $.each(Object.keys(l), function(_, k) {
                              keys[k] = 1;
                          });
                      });

                      dialog_key.empty();
                      $.each(Object.keys(keys), function(_, key) {
                          if (key == 'iteration' || key == 'epoch') return;

                          $('<option></option>')
                              .appendTo(dialog_key)
                              .attr('value', key)
                              .text(key);
                      });
                      dialog_key.prop('disabled', false);
                  });
              }
          }

          if (mode == 'open' || mode == 'series') {
              var used_colors = {};
              $.each(plot.series, function(_, series) {
                  used_colors[series.color] = 1;
              });
              var color = Math.floor(Math.random() * (1 << 24));
              for (var i = 0; i < colors.length; i++) {
                  if (! used_colors[colors[i]]) {
                      color = colors[i];
                      break;
                  }
              }
              dialog_color.val(int2hex(color));
          }

          if (mode == 'open') {
              dialog_yaxis.val([yaxis]);
          }

          if (mode == 'open' || mode == 'log') {
              if (dialog_log.val()) {
                  dialog_button.prop('disabled', false);
              } else {
                  dialog_button.prop('disabled', true);
              }
          }
      }

      function add_series() {
          var series = new Series(
              null,
              new Log($('#dialog-log').val()),
              $('#dialog-key').val(),
              hex2int($('#dialog-color').val()),
              $('input[name=dialog-yaxis]:checked').val(),
          );
          plot.series_add(series, function() {
              update_series();
          });
      }

      var timer;
      function set_timer() {
          if ($('#auto-fetch').prop('checked')) {
              timer = setInterval(
                  function () {
                      fetch_logs();
                      refresh_plot();
                  }, 5000);
          } else {
              clearInterval(timer);
          }
      }

      $(document).ready(function() {
          plot.fetch(update_series);
      });
    </script>
  </head>
  <body>
    </script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container col-md-12">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">Monitor</a>
        </div>
        <div class="collapse navbar-collapse" id="navbar">
        </div>
      </div>
    </nav>

    <div class="container col-md-9">
      <canvas id="plot"></canvas>
    </div>
    <aside class="col-md-3 sidebar-nav-fixed pull-right">
      <div class="panel panel-default">
        <div class="panel-heading"><h3 class="panel-title">General</h3></div>
        <table class="panel-body table">
          <tbody>
            <tr><td>Unit of X axis:</td><td>
              <input type="radio" name="xunit" value="iteration" onchange="refresh_plot()" checked> Iteration
              <input type="radio" name="xunit" value="epoch" onchange="refresh_plot()"> Epoch
            </td></tr>
            <tr><td># points:</td><td>
              <input type="radio" name="point-limit" value="256" onchange="refresh_plot()" checked> 256
              <input type="radio" name="point-limit" value="1024" onchange="refresh_plot()"> 1024
              <input type="radio" name="point-limit" value="" onchange="refresh_plot()"> No limit
            </td></tr>
            <tr><td>Auto fetch:</td><td>
              <input id="auto-fetch" type="checkbox" onchange="set_timer()" autocomplete="off" checked> Enabled
            </td></tr>
          </tbody>
        </table>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title pull-left">YAxis: Left</h3><br>
          <input id="use-logscale-0" type="checkbox" onchange="refresh_plot()"> Logscale
          <button
              class="btn btn-primary btn-sm pull-right" data-toggle="modal"
              data-target="#add-series" onclick="update_dialog('open', 0)">Add</button>
          <div class="clearfix"></div>
        </div>
        <table id="series-0" class="panel-body table">
          <tbody></tbody>
        </table>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title pull-left">YAxis: Right</h3><br>
          <input id="use-logscale-1" type="checkbox" onchange="refresh_plot()"> Logscale
          <button
              class="btn btn-primary btn-sm pull-right" data-toggle="modal"
              data-target="#add-series" onclick="update_dialog('open', 1)">Add</button>
          <div class="clearfix"></div>
        </div>
        <table id="series-1" class="panel-body table">
          <tbody></tbody>
        </table>
      </div>
    </aside>

    <div class="modal" id="add-series" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="modal-label">Add new series</h4>
          </div>
          <div class="modal-body">
            <select id="dialog-log" class="form-control" onchange="update_dialog('log')"></select>
            <select id="dialog-key" class="form-control"></select>
            <input id="dialog-color" type="color" class="form-control">
            <input type="radio" name="dialog-yaxis" value="0"> Left
            <input type="radio" name="dialog-yaxis" value="1"> Right
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button id="dialog-button" type="button" class="btn btn-primary" onclick="add_series()">Add</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
