<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Plot</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
      body {
          padding-top: 70px;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
    <script>
      var colors = ['red', 'blue', 'green', 'black'];

      var tokens = location.pathname.split('/');
      var id = tokens[tokens.length - 1];

      var plot = {};
      var series_logs = {};

      function add() {
          var log_select = $('#log-select');
          $.post(
              '/api/series',
              $.param({'plot': id, 'log': log_select.val()}),
              fetch
          );
      }

      function delete_(id) {
          $.ajax({
              url: '/api/series/' + id,
              type: 'DELETE',
              success: fetch
          });
      }

      function fetch() {
          $.getJSON('/api/plots/' + id, function(p) {
              plot = p;

              $.each(plot.series, function(id, s) {
                  $.getJSON('/api/logs/' + s.log, function(l) {
                      series_logs[s.log] = l;
                      update();
                  });
              });

              update();
          });
      }

      function update_dialog() {
          var log_select = $('#log-select');

          $.getJSON('/api/logs', function(logs) {
              $.each(plot.series, function(id, s) {
                  delete logs[s.log];
              });

              log_select.empty();
              $.each(logs, function(id, l) {
                  $('<option></option>')
                      .appendTo(log_select)
                      .attr('value', id)
                      .text(l.comment)
              });
          });
      }

      function update() {
          var xunit = 'iteration';
          if ($('#use_epoch').is(':checked')) {
              xunit = 'epoch';
          }

          var yscale = 'linear';
          if ($('#use_logscale').is(':checked')) {
              yscale = 'logarithmic';
          }

          var xmin = 0;
          var xmax = 0;

          var datasets = $.map(plot.series, function(s) {
              var log = series_logs[s.log];
              if (! log) {
                  return;
              }

              xmax = Math.max(xmax, log.content[log.content.length - 1][xunit]);
              var data = $.map(log.content, function(l) {
                  return {x: l[xunit], y: l['main/loss']};
              });

              return {
                  label: log.comment,
                  data: data,
                  borderColor: colors[s.color],
                  pointDot: false,
                  backgroundColor: 'rgba(0,0,0,0)'
              };
          });

          var chart = new Chart($('#plot'), {
              type: 'line',
              data: {datasets: datasets},
              options: {
                  elements: {
                      point: {radius: 0},
                      line: {tension: 0},
                  },
                  scales: {
                      xAxes: [{
                          type: 'linear',
                          position: 'bottom',
                          ticks: {min: xmin, max: xmax}
                      }],
                      yAxes: [{type: yscale}]
                  },
                  legend: {display: false}
              }
          });

          var series_panel = $('#series');
          series_panel.empty();
          $.each(plot.series, function(id, s) {
              var log = series_logs[s.log];
              if (! log) {
                  return;
              }

              $('<div></div>')
                  .attr('class', 'panel panel-default')
                  .appendTo(series_panel)
                  .append(
                      $('<div></div>')
                          .attr('class', 'panel-heading')
                          .append(
                              $('<h3></h3>')
                                  .text(log.comment)
                                  .attr('class', 'panel-title pull-left'))
                          .append(
                              $('<button></button>')
                                  .text('Delete')
                                  .attr('type', 'button')
                                  .attr('class', 'btn btn-danger btn-sm pull-right')
                                  .attr('onclick', 'delete_(' + id + ')'))
                          .append(
                              $('<div></div>')
                                  .attr('class', 'clearfix')))
                  .append(
                      $('<div></div>')
                          .attr('class', 'panel-body'))
          });
      }

      $(document).ready(function() {
          fetch();
          setInterval(fetch, 5000);
      });
    </script>
  </head>
  <body>
    </script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container col-md-12">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">Monitor</a>
        </div>
        <div class="collapse navbar-collapse" id="navbar">
        </div>
      </div>
    </nav>

    <div class="container col-md-9">
      <canvas id="plot"></canvas>
    </div>
    <aside class="col-md-3 sidebar-nav-fixed pull-right">
      <div class="panel panel-default">
        <div class="panel-heading">Setting</div>
        <div class="panel-body">
          <ul class="list-unstyled">
            <li><input id="use_epoch" type="checkbox" onChange="update()"> use epoch</li>
            <li><input id="use_logscale" type="checkbox" onChange="update()"> use log scale</li>
          </ul>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h2 class="panel-title pull-left">Series</h2>
          <button
              class="btn btn-primary btn-sm pull-right" data-toggle="modal"
              data-target="#add-series" onclick="update_dialog()">Add</button>
          <div class="clearfix"></div>
        </div>
        <div id="series" class="panel-body">
        </div>
      </div>
    </aside>

    <div class="modal" id="add-series" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="modal-label">Add new series</h4>
          </div>
          <div class="modal-body">
            <select id="log-select" class="form-control">
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Discard</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="add()">Add</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
