<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Plot</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
      body {
          padding-top: 70px;
      }
      .legend-color{
          padding: 0;
          margin: 0;
          border: 0;
          background: transparent;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
    <script>
      function int2rgb(c) {
          return 'rgb('
               + ((c >> 16) & 0xff) + ','
               + ((c >> 8) & 0xff) + ','
               + ((c >> 0) & 0xff) + ')';
      }

      function hex2int(c) {
          if (c[0] == '#') {
              c = c.slice(1);
          }
          return parseInt(c, 16);
      }

      function int2hex(c) {
          c = parseInt(c).toString(16);
          return '#' + ('000000' + c).slice(-6);
      }

      var colors = [0xff0000, 0x00ff00, 0x0000ff, 0x808000, 0x008080, 0x800080];

      var tokens = location.pathname.split('/');
      var id = tokens[tokens.length - 1];

      var plot = {};
      var logs = {};

      function new_series() {
          var log_select = $('#log-select');
          var key_select = $('#key-select');
          var color_select = $('#color-select');
          var yaxis_select = $('input[name=yaxis-select]:checked');
          $.post(
              '/api/series',
              $.param({
                  'plot': id,
                  'log': log_select.val(),
                  'key': key_select.val(),
                  'color': hex2int(color_select.val()),
                  'yaxis': yaxis_select.val()
              }),
              fetch_plot
          );
      }

      function del_series(id) {
          $.ajax({
              url: '/api/series/' + id,
              type: 'DELETE',
              success: fetch_plot
          });
      }

      function update_series(id) {
          var color_select = $('#color-select-' + id);
          $.ajax({
              url: '/api/series/' + id,
              type: 'PUT',
              data: $.param({'color': hex2int(color_select.val())}),
              success: fetch_plot
          });
      }

      function fetch_plot() {
          $.getJSON('/api/plots/' + id, function(p) {
              plot = p;
              refresh_series();
              refresh_plot();
              refresh_dialog('series');
              fetch_logs();
          });
      }

      function fetch_logs() {
          $.each(plot.series, function(id, s) {
              $.getJSON('/api/logs/' + s.log.id, function(l) {
                  var new_log = ! logs[s.log.id];
                  logs[s.log.id] = l;
                  if (new_log) {
                      refresh_plot();
                  }
              });
          });
      }

      function refresh_series() {
          for (var yaxis = 0; yaxis < 2; yaxis++) {
              var tbody = $('#series-' + yaxis + ' > tbody');
              tbody.empty();
              $.each(plot.series, function(id, s) {
                  if (s.yaxis != yaxis) {
                      return;
                  }
                  var tr = $('<tr></tr>').appendTo(tbody);
                  $('<td></td>').appendTo(tr).append(
                      $('<input></input>')
                          .attr('id', 'color-select-' + id)
                          .attr('type', 'color')
                          .attr('class', 'legend-color')
                          .attr('value', int2hex(s.color))
                          .attr('onchange', 'update_series(' + id + ')'));
                  $('<td></td>').appendTo(tr)
                                .attr('width', '70%')
                                .text(s.log.comment + ': ' + s.key);
                  $('<td></td>').appendTo(tr).append(
                      $('<button></button>')
                          .text('Delete')
                          .attr('type', 'button')
                          .attr('class', 'btn btn-danger btn-sm pull-right')
                          .attr('onclick', 'del_series(' + id + ')'));
              });
          }
      }

      var chart = null;

      function refresh_plot() {
          var xunit = 'iteration';
          if ($('#use-epoch').is(':checked')) {
              xunit = 'epoch';
          }

          var yscales = ['linear', 'linear'];
          for (var yaxis = 0; yaxis < yscales.length; yaxis++) {
              if ($('#use-logscale-' + yaxis).is(':checked')) {
                  yscales[yaxis] = 'logarithmic';
              }
              if (chart && chart.options.scales.yAxes[yaxis].type != yscales[yaxis]) {
                  chart = null;
              }
          }

          var xmin = 0;
          var xmax = 0;

          var datasets = $.map(plot.series, function(s) {
              var log = logs[s.log.id];
              if (! log) {
                  return;
              }

              var data_with_key = $.map(log.content, function(l) {
                  if (s.key in l) {
                      return {x: l[xunit], y: l[s.key]};
                  }
              });

              xmax = Math.max(xmax, data_with_key[data_with_key.length - 1].x);

              var interval = 1;
              var point_limit = $('input[name=point-limit]:checked').val();
              if (point_limit != '' && data_with_key.length > point_limit) {
                  interval = data_with_key.length / point_limit;
              }

              var data = [];
              for (var i = 0; i < data_with_key.length; i += interval) {
                  data.push(data_with_key[Math.floor(i)]);
              }

              return {
                  label: s.log.comment,
                  data: data,
                  borderColor: int2rgb(s.color),
                  yAxisID: s.yaxis,
                  pointDot: false,
                  fill: false
              };
          });

          if (! chart){
              chart = new Chart($('#plot'), {
                  type: 'line',
                  data: {datasets: datasets},
                  options: {
                      elements: {
                          line: {tension: 0},
                      },
                      scales: {
                          xAxes: [{type: 'linear', position: 'bottom'}],
                          yAxes: [
                              {id: 0, type: yscales[0], position: 'left'},
                              {id: 1, type: yscales[1], position: 'right',
                               gridLines: {drawOnChartArea: false}}]
                      },
                      legend: {display: false},
                      animation: false
                  }
              });
          }

          chart.data.datasets = datasets;
          chart.options.scales.xAxes[0].ticks.min = xmin;
          chart.options.scales.xAxes[0].ticks.max = xmax;
          chart.update();
      }

      function refresh_dialog(mode, yaxis) {
          var log_select = $('#log-select');
          var key_select = $('#key-select');
          var color_select = $('#color-select');
          var add_button = $('#add-button');

          if (mode == 'open') {
              log_select.prop('disabled', true);

              $.getJSON('/api/logs', function(all_logs) {
                  log_select.empty();
                  $('<option></option>').appendTo(log_select)
                  $.each(all_logs, function(id, l) {
                      $('<option></option>')
                          .appendTo(log_select)
                          .attr('value', id)
                          .text(l.comment);
                  });
                  log_select.prop('disabled', false);
              });
          }

          if (mode == 'open' || mode == 'log') {
              key_select.prop('disabled', true);

              var id = log_select.val();
              if (id) {
                  $.getJSON('/api/logs/' + id, function(l) {
                      logs[id] = l;

                      var keys = {};
                      $.each(logs[id].content, function(i, l){
                          $.each(Object.keys(l), function(j, k) {
                              keys[k] = 1;
                          });
                      });

                      key_select.empty();
                      $.each(Object.keys(keys), function(i, k) {
                          if (k == 'iteration' || k == 'epoch') {
                              return;
                          }
                          $('<option></option>')
                              .appendTo(key_select)
                              .attr('value', k)
                              .text(k);
                      });
                      key_select.prop('disabled', false);
                  });
              }
          }

          if (mode == 'open' || mode == 'series') {
              var used_colors = {};
              $.each(plot.series, function(id, s) {
                  used_colors[s.color] = 1;
              });
              var color = Math.floor(Math.random() * (1 << 24));
              for (var i = 0; i < colors.length; i++) {
                  if (! used_colors[colors[i]]) {
                      color = colors[i];
                      break;
                  }
              }
              color_select.val(int2hex(color));
          }

          if (mode == 'open'){
              $('input[name=yaxis-select]').val([yaxis]);
          }

          if (mode == 'open' || mode == 'log') {
              if (log_select.val()) {
                  add_button.prop('disabled', false);
              } else {
                  add_button.prop('disabled', true);
              }
          }
      }

      $(document).ready(function() {
          fetch_plot();
          setInterval(fetch_logs, 5000);
          setInterval(refresh_plot, 5000);
      });
    </script>
  </head>
  <body>
    </script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container col-md-12">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">Monitor</a>
        </div>
        <div class="collapse navbar-collapse" id="navbar">
        </div>
      </div>
    </nav>

    <div class="container col-md-9">
      <canvas id="plot"></canvas>
    </div>
    <aside class="col-md-3 sidebar-nav-fixed pull-right">
      <div class="panel panel-default">
        <div class="panel-heading"><h3 class="panel-title">XAxis</h3></div>
        <div class="panel-body">
          <ul class="list-unstyled">
            <li><input id="use-epoch" type="checkbox" onchange="refresh_plot()"> use epoch</li>
            <li>
              # points:
              <input type="radio" name="point-limit" value="256" onchange="refresh_plot()" checked> 256
              <input type="radio" name="point-limit" value="1024" onchange="refresh_plot()"> 1024
              <input type="radio" name="point-limit" value="" onchange="refresh_plot()"> No limit
            </li>
          </ul>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title pull-left">YAxis: Left</h3>
          <div class="btn-group pull-right" data-toggle="buttons">
            <label class="btn btn-default btn-sm">
              <input id="use-logscale-0" type="checkbox"
                     onchange="refresh_plot()" autocomplete="off">Logscale
            </label>
            <button
                class="btn btn-primary btn-sm" data-toggle="modal"
                data-target="#add-series" onclick="refresh_dialog('open', 0)">Add</button>
          </div>
          <div class="clearfix"></div>
        </div>
        <table id="series-0" class="panel-body table">
          <tbody></tbody>
        </table>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title pull-left">YAxis: Right</h3>
          <div class="btn-group pull-right" data-toggle="buttons">
            <label class="btn btn-default btn-sm">
              <input id="use-logscale-1" type="checkbox"
                     onchange="refresh_plot()" autocomplete="off">Logscale
            </label>
            <button
                class="btn btn-primary btn-sm" data-toggle="modal"
                data-target="#add-series" onclick="refresh_dialog('open', 1)">Add</button>
          </div>
          <div class="clearfix"></div>
        </div>
        <table id="series-1" class="panel-body table">
          <tbody></tbody>
        </table>
      </div>
    </aside>

    <div class="modal" id="add-series" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="modal-label">Add new series</h4>
          </div>
          <div class="modal-body">
            <select id="log-select" class="form-control" onchange="refresh_dialog('log')"></select>
            <select id="key-select" class="form-control"></select>
            <input id="color-select" type="color" class="form-control">
            <input type="radio" name="yaxis-select" value="0" autocomplete="off"> Left
            <input type="radio" name="yaxis-select" value="1" autocomplete="off"> Right
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button id="add-button" type="button" class="btn btn-primary" onclick="new_series()">Add</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
