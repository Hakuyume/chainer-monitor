<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Plot</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
      body {
          padding-top: 70px;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
    <script>
      function int2rgb(c) {
          return 'rgb('
               + ((c >> 16) & 0xff) + ','
               + ((c >> 8) & 0xff) + ','
               + ((c >> 0) & 0xff) + ')';
      }

      function hex2int(c) {
          if (c[0] == '#') {
              c = c.slice(1);
          }
          return parseInt(c, 16);
      }

      function int2hex(c) {
          c = parseInt(c).toString(16);
          return '#' + ('000000' + c).slice(-6);
      }

      var colors = [0xff0000, 0x00ff00, 0x0000ff, 0x808000, 0x008080, 0x800080];

      var tokens = location.pathname.split('/');
      var id = tokens[tokens.length - 1];

      var plot = {};
      var series_logs = {};

      function add() {
          var log_select = $('#log-select');
          var color_select = $('#color-select');
          $.post(
              '/api/series',
              $.param({
                  'plot': id,
                  'log': log_select.val(),
                  'color': hex2int(color_select.val()),
              }),
              fetch_plot
          );
      }

      function delete_(id) {
          $.ajax({
              url: '/api/series/' + id,
              type: 'DELETE',
              success: fetch_plot
          });
      }

      function fetch_plot() {
          $.getJSON('/api/plots/' + id, function(p) {
              plot = p;
              update_series();
              fetch_logs();
          });
      }

      function fetch_logs() {
          update_plot();

          $.each(plot.series, function(id, s) {
              $.getJSON('/api/logs/' + s.log.id, function(l) {
                  series_logs[s.log.id] = l;
                  update_plot();
              });
          });
      }

      function update_series() {
          var series_panel = $('#series');
          series_panel.empty();
          $.each(plot.series, function(id, s) {
              $('<div></div>')
                  .attr('class', 'panel panel-default')
                  .appendTo(series_panel)
                  .append(
                      $('<div></div>')
                          .attr('class', 'panel-heading')
                          .append(
                              $('<h3></h3>')
                                  .text(s.log.comment)
                                  .attr('class', 'panel-title pull-left'))
                          .append(
                              $('<button></button>')
                                  .text('Delete')
                                  .attr('type', 'button')
                                  .attr('class', 'btn btn-danger btn-sm pull-right')
                                  .attr('onclick', 'delete_(' + id + ')'))
                          .append(
                              $('<div></div>')
                                  .attr('class', 'clearfix')))
                  .append(
                      $('<div></div>')
                          .attr('class', 'panel-body')
                          .append(
                              $('<input></input>')
                                  .attr('type', 'color')
                                  .attr('disabled', 'disabled')
                                  .attr('class', 'form-control')
                                  .attr('value', int2hex(s.color))))
          });
      }

      function update_plot() {
          var xunit = 'iteration';
          if ($('#use_epoch').is(':checked')) {
              xunit = 'epoch';
          }

          var yscale = 'linear';
          if ($('#use_logscale').is(':checked')) {
              yscale = 'logarithmic';
          }

          var xmin = 0;
          var xmax = 0;

          var datasets = $.map(plot.series, function(s) {
              var log = series_logs[s.log.id];
              if (! log) {
                  return;
              }

              xmax = Math.max(xmax, log.content[log.content.length - 1][xunit]);
              var data = $.map(log.content, function(l) {
                  return {x: l[xunit], y: l['main/loss']};
              });

              return {
                  label: s.log.comment,
                  data: data,
                  borderColor: int2rgb(s.color),
                  pointDot: false,
                  backgroundColor: 'rgba(0,0,0,0)'
              };
          });

          var chart = new Chart($('#plot'), {
              type: 'line',
              data: {datasets: datasets},
              options: {
                  elements: {
                      point: {radius: 0},
                      line: {tension: 0},
                  },
                  scales: {
                      xAxes: [{
                          type: 'linear',
                          position: 'bottom',
                          ticks: {min: xmin, max: xmax}
                      }],
                      yAxes: [{type: yscale}]
                  },
                  legend: {display: false}
              }
          });
      }

      function update_dialog() {
          var log_select = $('#log-select');
          var color_select = $('#color-select');

          var used_colors = {};
          $.each(plot.series, function(id, s) {
              used_colors[s.color] = 1;
          });

          var color = Math.floor(Math.random() * (1 << 24));
          for (var i = 0; i < colors.length; i++) {
              if (! used_colors[colors[i]]) {
                  color = colors[i];
                  break;
              }
          }
          color_select.val(int2hex(color));

          $.getJSON('/api/logs', function(logs) {
              $.each(plot.series, function(id, s) {
                  delete logs[s.log.id];
              });

              log_select.empty();
              $.each(logs, function(id, l) {
                  $('<option></option>')
                      .appendTo(log_select)
                      .attr('value', id)
                      .text(l.comment)
              });
          });
      }

      $(document).ready(function() {
          fetch_plot();
          setInterval(fetch_logs, 5000);
      });
    </script>
  </head>
  <body>
    </script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container col-md-12">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">Monitor</a>
        </div>
        <div class="collapse navbar-collapse" id="navbar">
        </div>
      </div>
    </nav>

    <div class="container col-md-9">
      <canvas id="plot"></canvas>
    </div>
    <aside class="col-md-3 sidebar-nav-fixed pull-right">
      <div class="panel panel-default">
        <div class="panel-heading">Setting</div>
        <div class="panel-body">
          <ul class="list-unstyled">
            <li><input id="use_epoch" type="checkbox" onChange="update_plot()"> use epoch</li>
            <li><input id="use_logscale" type="checkbox" onChange="update_plot()"> use log scale</li>
          </ul>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h2 class="panel-title pull-left">Series</h2>
          <button
              class="btn btn-primary btn-sm pull-right" data-toggle="modal"
              data-target="#add-series" onclick="update_dialog()">Add</button>
          <div class="clearfix"></div>
        </div>
        <div id="series" class="panel-body">
        </div>
      </div>
    </aside>

    <div class="modal" id="add-series" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="modal-label">Add new series</h4>
          </div>
          <div class="modal-body">
            <select id="log-select" class="form-control">
            </select>
            <input id="color-select" type="color" class="form-control">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Discard</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="add()">Add</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
